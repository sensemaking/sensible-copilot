name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      plugin_version: ${{ steps.get_version.outputs.plugin_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set plugin minor version to run number
        env:
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          MAJOR=$(grep -E '^version:' copilot-plugin.yml | sed -E 's/[^0-9]*([0-9]+)\..*/\1/')
          NEW_VERSION="${MAJOR}.${RUN_NUMBER}.0"
          echo "Setting copilot-plugin.yml version to $NEW_VERSION"
          sed -E -i "s/^([[:space:]]*version:[[:space:]]*)\"?[0-9]+\.[0-9]+\.[0-9]+\"?/\1\"${NEW_VERSION}\"/" copilot-plugin.yml
          cat copilot-plugin.yml
      - name: Extract plugin version
        id: get_version
        run: |
          VERSION=$(grep -E -o '[0-9]+\.[0-9]+\.[0-9]+' copilot-plugin.yml | head -n1)
          echo "plugin_version=$VERSION" >> $GITHUB_OUTPUT
      - name: Build package
        run: bash ./scripts/build.sh
      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: plugin-package
          path: plugin-*.zip
      - name: Validate manifest fields
        run: |
          grep -E '^name:' copilot-plugin.yml
          grep -E '^id:' copilot-plugin.yml
          grep -E '^version:' copilot-plugin.yml

  release:
    needs: build

    runs-on: ubuntu-latest
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: plugin-package
      - name: Get artifact file name
        run: |
          echo "ARTIFACT=$(ls plugin-*.zip | head -n1)" >> $GITHUB_ENV
      - name: Create or find GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PLUGIN_VERSION: ${{ needs.build.outputs.plugin_version }}
          TAG_NAME: v${{ needs.build.outputs.plugin_version }}
          REPO: ${{ github.repository }}
        run: |
          echo "Using plugin version: $PLUGIN_VERSION"
          echo "Using tag name: $TAG_NAME"
          # Check for existing release with this tag
          response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/$REPO/releases/tags/$TAG_NAME")
          release_id=$(echo "$response" | jq -r '.id // empty')
          if [ -n "$release_id" ]; then
            echo "Found existing release id: $release_id"
            echo "RELEASE_ID=$release_id" >> $GITHUB_ENV
          else
            payload=$(printf '{"tag_name":"%s","name":"Release %s","draft":false}' "$TAG_NAME" "$TAG_NAME")
            response=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$payload" "https://api.github.com/repos/$REPO/releases")
            release_id=$(echo "$response" | jq -r '.id')
            if [ -z "$release_id" ] || [ "$release_id" = "null" ]; then
              echo "Failed to create release: $response"
              exit 1
            fi
            echo "RELEASE_ID=$release_id" >> $GITHUB_ENV
          fi
      - name: Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT: ${{ env.ARTIFACT }}
          REPO: ${{ github.repository }}
        run: |
          upload_url="https://uploads.github.com/repos/$REPO/releases/$RELEASE_ID/assets?name=$(basename $ARTIFACT)"
          echo "Uploading $ARTIFACT to $upload_url"
          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/zip" --data-binary @"$ARTIFACT" "$upload_url"

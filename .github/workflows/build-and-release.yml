name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Build package
        run: bash ./scripts/build.sh
      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: plugin-package
          path: plugin-*.zip
      - name: Validate manifest fields
        run: |
          grep -E '^name:' copilot-plugin.yml
          grep -E '^id:' copilot-plugin.yml
          grep -E '^version:' copilot-plugin.yml

  release:
    needs: build

    runs-on: ubuntu-latest
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: plugin-package
      - name: Get artifact file name
        run: |
          echo "ARTIFACT=$(ls plugin-*.zip | head -n1)" >> $GITHUB_ENV
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          echo "Creating release for: $TAG_NAME"
          payload=$(printf '{"tag_name":"%s","name":"Release %s","draft":false}' "$TAG_NAME" "$TAG_NAME")
          response=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$payload" "https://api.github.com/repos/$REPO/releases")
          release_id=$(echo "$response" | jq -r '.id')
          if [ "$release_id" = "null" ] || [ -z "$release_id" ]; then
            echo "Failed to create release: $response"
            exit 1
          fi
          echo "RELEASE_ID=$release_id" >> $GITHUB_ENV
      - name: Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT: ${{ env.ARTIFACT }}
          REPO: ${{ github.repository }}
        run: |
          upload_url="https://uploads.github.com/repos/$REPO/releases/$RELEASE_ID/assets?name=$(basename $ARTIFACT)"
          echo "Uploading $ARTIFACT to $upload_url"
          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/zip" --data-binary @"$ARTIFACT" "$upload_url"
